<html>
    <script src="miniajax.js" type="application/javascript"></script>
    <script src="base64.js" type="application/javascript"></script>
    <script src="bytebuffer.js" type="application/javascript"></script>
    <script src="mmp.js" type="application/javascript"></script>
    <script src="streamer.js" type="application/javascript"></script>
    <script type="application/javascript">

        var mmp;
        var demo;
        var streamer;

        function initdemo() {

            var ch;
            ch = document.getElementById('channel1');
            ch.addEventListener('change', function(e) {
                mmp.setMute(0, e.target.checked);
            });

            ch = document.getElementById('channel2');
            ch.addEventListener('click', function(e) {
                mmp.setMute(1, e.target.checked);
            });

            ch = document.getElementById('channel3');
            ch.addEventListener('click', function(e) {
                mmp.setMute(2, e.target.checked);
            });

            ch = document.getElementById('channel4');
            ch.addEventListener('click', function(e) {
                mmp.setMute(3, e.target.checked);
            });

            ch = document.getElementById('b1');
            ch.addEventListener('click', function() {
                if (streamer.isPlaying())
                    streamer.stop();
                else
                    streamer.play();
                updatebutton();
            });

            ch = document.getElementById('fwd');
            ch.addEventListener('click', function(){
                mmp.setSongPosition(mmp.getSongPosition() + 1);
            });

            ch = document.getElementById('bck');
            ch.addEventListener('click', function(){
                mmp.setSongPosition(mmp.getSongPosition() - 1);
            });


            ch = document.getElementById('mod');
            ch.addEventListener('change', function(e) {
                // console.log(e);
                var fn = (e.target.options[e.target.selectedIndex].value);
                streamer.stop();
                updatebutton();
                loadMod(fn);
            });

            function loadMod(modfile) {
                ajax.get(modfile, function(modtext) {
                    console.log('b64 len', modtext.length);
                    var moddata = atob(modtext);
                    var modbytes = [];
                    for (var k = 0; k < moddata.length; k++)
                        modbytes.push(moddata.charCodeAt(k));
                    console.log("binary len:", modbytes.length);
                    mmp = new MMP(modbytes);
                    // demo = sinus_create();
                    var buffers = [];
                    buffers.push(document.getElementById('a1'));
                    buffers.push(document.getElementById('a2'));
                    buffers.push(document.getElementById('a3'));
                    // console.log(buffers);
                    streamer = new Streamer(mmp, buffers, 44100);
                    updatebutton();

                    ch = document.getElementById('nam');
                    ch.value = mmp.getSongName();
                });
            }

            var modfile = ch.options[ch.selectedIndex].value;
            loadMod(modfile);

            setInterval(function() {
                if (mmp) {

                    ch = document.getElementById('pos');
                    ch.value = ''+mmp.getSongPosition()+'.'+mmp.getSongRow();

                    ch = document.getElementById('vu1');
                    ch.value = ''+mmp.getVU(0);

                    ch = document.getElementById('vu2');
                    ch.value = ''+mmp.getVU(1);

                    ch = document.getElementById('vu3');
                    ch.value = ''+mmp.getVU(2);

                    ch = document.getElementById('vu4');
                    ch.value = ''+mmp.getVU(3);

                }
            }, 25);
        }

        function updatebutton(){
            if (streamer.isPlaying()) {
                b1.innerHTML = 'Stop';
            }
            else {
                b1.innerHTML = 'Play';
            }
        }

    </script>
    <body onload="initdemo()">

        <select id="mod">
            <option>- pick module -</option>
            <option value="desert1.mod.b64">desert1.mod</option>
            <option value="desert2.mod.b64" selected>desert2.mod</option>
            <option value="desert3.mod.b64">desert3.mod</option>
        </select>

        <audio id="a1"></audio>
        <audio id="a2"></audio>
        <audio id="a3"></audio>

        <button id="b1">Loading...</button>

        <button id="bck">&lt;&lt;</button>
        <button id="fwd">&gt;&gt;</button>

        <input type="text" id="pos" size="5" />

        <input type="text" id="nam" size="5" />

        <input type="checkbox" id="channel1" />
        <input type="text" id="vu1" size="4" />

        <input type="checkbox" id="channel2" />
        <input type="text" id="vu2" size="4" />

        <input type="checkbox" id="channel3" />
        <input type="text" id="vu3" size="4" />

        <input type="checkbox" id="channel4" />
        <input type="text" id="vu4" size="4" />


    </body>
</html>
